#cloud-config

package_update: true
package_upgrade: true

packages:
  - caddy
  - podman
  - podman-compose
  - unattended-upgrades
  - git

users:
  - name: admin
    groups: [sudo]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_public_key}

apt:
  sources:
    caddy:
      source: deb [trusted=yes] https://dl.cloudsmith.io/public/caddy/stable/deb/debian $RELEASE main

write_files:
  - path: /etc/ssh/sshd_config.d/99-security.conf
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      PubkeyAuthentication yes
      Protocol 2
      X11Forwarding no
      MaxAuthTries 3
      ClientAliveInterval 300
      ClientAliveCountMax 2

runcmd:
  # Clone repository and set correct permissions
  - |
    if [ ! -d /opt/apinasaari-slackbots ]; then
      mkdir -p /opt/apinasaari-slackbots
      chown admin:admin /opt/apinasaari-slackbots
      sudo -u admin git clone https://github.com/penny-five/apinasaari-slackbots.git /opt/apinasaari-slackbots
    fi
  # Create symlinks for config files
  - ln -sf /opt/apinasaari-slackbots/config/Caddyfile /etc/caddy/Caddyfile
  - ln -sf /opt/apinasaari-slackbots/config/services/n8n.service /etc/systemd/system/n8n.service
  # Enable and restart services
  - systemctl daemon-reload
  - systemctl enable caddy n8n
  - systemctl start caddy n8n

final_message: 'Cloud-init finished successfully at $TIMESTAMP'
